from OmnibusDriver import OmnibusDriver
import json

od = OmnibusDriver('10.69.20.76', '8080', 'nmsadmin', 'nmsadmin')
uri = "/objectserver/restapi/alerts/status"
intern_id1 = 'intern-test1'
summary = "Intern testing"
new_row_data = {
        'Identifier': intern_id1,
        'Summary': summary,
        'methodProcedure': 'IGNORE'
        }
print "testing insert"
res = od.insert(uri, new_row_data)
new_row_serial = res['Serial']
print "testing query"
res = od.query("select * from alerts.status where Serial=" + new_row_serial)
res = json.loads(res)['rowset']['rows']
assert len(res) == 1
assert res[0]['Identifier'] == new_row_data['Identifier']
print "testing select"
res = od.select(uri, ['Identifier'], "Serial=" + new_row_serial)
assert len(res) == 1
assert res[0]['Identifier'] == new_row_data['Identifier']
intern_id2 = 'intern-test2'
new_row_data2 = {
        'Identifier': intern_id2,
        'Summary': summary,
        'methodProcedure': 'IGNORE'
        }
print "testing insert"
res = od.insert(uri, new_row_data2)
new_row_serial2 = res['Serial']
print "testing select by Identifier"
res = od.select(uri, ['Identifier', 'Summary', 'Serial', 'methodProcedure'], 
                "Summary='" + summary + "'", "Serial ASC")
assert len(res) == 2
assert int(res[0]['Serial']) < int(res[1]['Serial'])
assert res[0]['methodProcedure'] == new_row_data['methodProcedure']
assert res[1]['Identifier'] == intern_id2
print "testing select"
res = od.select(uri, ['Identifier', 'Summary', 'Serial', 'methodProcedure'], 
                "Summary='" + summary + "'", "Serial DESC")
assert len(res) == 2
assert int(res[0]['Serial']) > int(res[1]['Serial'])
assert res[0]['methodProcedure'] == new_row_data['methodProcedure']
assert res[1]['Identifier'] == intern_id1
update_data = {
        'Summary': 'Updated intern testing'
        }
update_data2 = {
        'Summary': 'Updated intern testing 2'
        }
print "testing update"
res = od.update(uri, data=update_data, where=("Serial=" + new_row_serial))
res = od.update(uri, update_data2, "Serial=" + new_row_serial2)
res = od.select(uri, 'Summary', "Identifier='" + intern_id1 + "'", "Serial DESC")
assert len(res) == 1
assert res[0]['Summary'] == update_data['Summary']
res = od.select(uri, 'Summary', "Identifier='" + intern_id2 + "'", "Serial DESC")
assert len(res) == 1
assert res[0]['Summary'] == update_data2['Summary']
print "testing delete"
res = od.delete(uri, "Serial=" + new_row_serial)
res = od.query("DELETE FROM alerts.status WHERE Serial=" + new_row_serial2)
res = od.select(uri, 'Identifier', "Summary = '" + summary + "'")
assert len(res) == 0
print "testing complex WHERE statement in select"
res = od.select(uri, ['Serial', 'Summary', 'methodProcedure'],
                'Serial > 6000 AND Serial < 7000 OR Serial > 8000', 
                'Serial ASC')
prev_si = 0
for r in res:
    si = int(r['Serial'])
    assert (si > 6000 and si < 7000) or si > 8000
    assert si > prev_si
    prev_si = si
